name: Assign Latest Milestone

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  assign-latest-milestone:
    runs-on: ubuntu-latest

    steps:
      - name: Assign the latest milestone
        uses: actions/github-script@v6
        with:
          script: |
            const github = require('@actions/github');
            const context = github.context;

            async function run() {
              // Fetch milestones
              const milestones = await github.rest.issues.listMilestones({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                sort: 'due_on',
                direction: 'desc'
              });

              if (milestones.data.length === 0) {
                throw new Error('No open milestones found.');
              }

              // Get the latest milestone
              const latestMilestone = milestones.data[0];

              // Assign the latest milestone to the PR
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                milestone: latestMilestone.number
              });
            }

            run().catch(error => {
              core.setFailed(error.message);
            });
